<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ICPP 설문</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="./js/supabase.js"></script>
  <script src="./js/icpp.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      line-height: 1.8;
    }
    label {
      display: block;
      margin-bottom: 15px;
    }
    fieldset {
      margin-bottom: 20px;
    }
    button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1.2rem;
      cursor: pointer;
    }
    #resultMessage {
      margin-top: 20px;
      color: red;
    }
  </style>
</head>
<body>
  <h1>ICPP 설문</h1>

  <!-- 회원 이름 -->
  <label>회원 이름: <input type="text" id="clientName" required /></label>

 <!-- Catastrophizing -->
 <fieldset>
    <legend>Catastrophizing (통증을 과하게 부정적으로 해석하는 경향)</legend>
    <label>C1: 통증이 생기면 “이제 더 악화되어 큰일 날 것 같다”는 생각이 든다.</label>
    <label><input type="radio" name="C1" value="0" required> 0</label>
    <label><input type="radio" name="C1" value="1"> 1</label>
    <label><input type="radio" name="C1" value="2"> 2</label>
    <label><input type="radio" name="C1" value="3"> 3</label>
    <label><input type="radio" name="C1" value="4"> 4</label>
    <label><input type="radio" name="C1" value="5"> 5</label>
    <label>C2: 통증을 느끼면, 머릿속에서 그 통증에 대한 걱정이 계속 맴돈다.</label>
    <label><input type="radio" name="C2" value="0" required> 0</label>
    <label><input type="radio" name="C2" value="1"> 1</label>
    <label><input type="radio" name="C2" value="2"> 2</label>
    <label><input type="radio" name="C2" value="3"> 3</label>
    <label><input type="radio" name="C2" value="4"> 4</label>
    <label><input type="radio" name="C2" value="5"> 5</label>
    <label>C3: 통증이 조금이라도 느껴지면, “내 몸이 망가졌을지도 모른다”고 생각한다.</label>
    <label><input type="radio" name="C3" value="0" required> 0</label>
    <label><input type="radio" name="C3" value="1"> 1</label>
    <label><input type="radio" name="C3" value="2"> 2</label>
    <label><input type="radio" name="C3" value="3"> 3</label>
    <label><input type="radio" name="C3" value="4"> 4</label>
    <label><input type="radio" name="C3" value="5"> 5</label>
  </fieldset>
    <!-- Fear-Avoidance -->
    <fieldset>
        <legend>Fear-Avoidance (통증 유발이 두려워 활동을 회피하는 정도)</legend>
        <label>F1: 통증이 발생할까 봐, 평소에 하던 일이나 운동을 피하게 된다.</label>
        <label><input type="radio" name="F1" value="0" required> 0</label>
        <label><input type="radio" name="F1" value="1"> 1</label>
        <label><input type="radio" name="F1" value="2"> 2</label>
        <label><input type="radio" name="F1" value="3"> 3</label>
        <label><input type="radio" name="F1" value="4"> 4</label>
        <label><input type="radio" name="F1" value="5"> 5</label>
        <label>F2: (운동·활동 중) 통증이 생길 수 있다고 생각하면, 아예 시도하지 않으려 한다.</label>
        <label><input type="radio" name="F2" value="0" required> 0</label>
        <label><input type="radio" name="F2" value="1"> 1</label>
        <label><input type="radio" name="F2" value="2"> 2</label>
        <label><input type="radio" name="F2" value="3"> 3</label>
        <label><input type="radio" name="F2" value="4"> 4</label>
        <label><input type="radio" name="F2" value="5"> 5</label>
        <label>F3: 통증이 재발할까 두려워서, 활동 범위를 크게 줄였다.</label>
        <label><input type="radio" name="F3" value="0" required> 0</label>
        <label><input type="radio" name="F3" value="1"> 1</label>
        <label><input type="radio" name="F3" value="2"> 2</label>
        <label><input type="radio" name="F3" value="3"> 3</label>
        <label><input type="radio" name="F3" value="4"> 4</label>
        <label><input type="radio" name="F3" value="5"> 5</label>
      </fieldset>
  
      <!-- Kinesiophobia -->
      <fieldset>
        <legend>Kinesiophobia (움직임 자체에 대한 공포)</legend>
        <label>K1: 몸을 움직이는 것 자체가 위험하다고 느껴, 사소한 동작도 겁이 난다.</label>
        <label><input type="radio" name="K1" value="0" required> 0</label>
        <label><input type="radio" name="K1" value="1"> 1</label>
        <label><input type="radio" name="K1" value="2"> 2</label>
        <label><input type="radio" name="K1" value="3"> 3</label>
        <label><input type="radio" name="K1" value="4"> 4</label>
        <label><input type="radio" name="K1" value="5"> 5</label>
        <label>K2: 통증이 없을 때에도, 혹시 움직이면 다시 아플까 봐 조심하게 된다.</label>
        <label><input type="radio" name="K2" value="0" required> 0</label>
        <label><input type="radio" name="K2" value="1"> 1</label>
        <label><input type="radio" name="K2" value="2"> 2</label>
        <label><input type="radio" name="K2" value="3"> 3</label>
        <label><input type="radio" name="K2" value="4"> 4</label>
        <label><input type="radio" name="K2" value="5"> 5</label>
        <label>K3: 재활운동이나 스트레칭을 해도 괜찮다는 말을 들어도, 여전히 움직이는 게 두렵다.</label>
        <label><input type="radio" name="K3" value="0" required> 0</label>
        <label><input type="radio" name="K3" value="1"> 1</label>
        <label><input type="radio" name="K3" value="2"> 2</label>
        <label><input type="radio" name="K3" value="3"> 3</label>
        <label><input type="radio" name="K3" value="4"> 4</label>
        <label><input type="radio" name="K3" value="5"> 5</label>
      </fieldset>
  
      <!-- Anxiety/Depression -->
      <fieldset>
        <legend>Anxiety/Depression (불안·우울)</legend>
        <label>A1: 내 통증은 앞으로도 나아질 기미가 없을 것 같아 기분이 가라앉는다.</label>
        <label><input type="radio" name="A1" value="0" required> 0</label>
        <label><input type="radio" name="A1" value="1"> 1</label>
        <label><input type="radio" name="A1" value="2"> 2</label>
        <label><input type="radio" name="A1" value="3"> 3</label>
        <label><input type="radio" name="A1" value="4"> 4</label>
        <label><input type="radio" name="A1" value="5"> 5</label>
        <label>A2: 통증 때문에 미래가 불안하거나 걱정된다.</label>
        <label><input type="radio" name="A2" value="0" required> 0</label>
        <label><input type="radio" name="A2" value="1"> 1</label>
        <label><input type="radio" name="A2" value="2"> 2</label>
        <label><input type="radio" name="A2" value="3"> 3</label>
        <label><input type="radio" name="A2" value="4"> 4</label>
        <label><input type="radio" name="A2" value="5"> 5</label>
        <label>A3: 내가 원래 좋아하던 일들도, 통증 때문에 흥미가 떨어져 우울해진다.</label>
        <label><input type="radio" name="A3" value="0" required> 0</label>
        <label><input type="radio" name="A3" value="1"> 1</label>
        <label><input type="radio" name="A3" value="2"> 2</label>
        <label><input type="radio" name="A3" value="3"> 3</label>
        <label><input type="radio" name="A3" value="4"> 4</label>
        <label><input type="radio" name="A3" value="5"> 5</label>
      </fieldset>
  
      <!-- Self-Efficacy -->
      <fieldset>
        <legend>Self-Efficacy (통증 상황에서도 스스로 해낼 수 있다는 믿음)</legend>
        <label>S1: 통증이 있어도, 내 일상생활(가사·직장 등)을 어느 정도 해낼 수 있다.</label>
        <label><input type="radio" name="S1" value="0" required> 0</label>
        <label><input type="radio" name="S1" value="1"> 1</label>
        <label><input type="radio" name="S1" value="2"> 2</label>
        <label><input type="radio" name="S1" value="3"> 3</label>
        <label><input type="radio" name="S1" value="4"> 4</label>
        <label><input type="radio" name="S1" value="5"> 5</label>
        <label>S2: 통증이 심해져도, 스스로 조절하거나 대처할 수 있는 방법이 있다고 생각한다.</label>
        <label><input type="radio" name="S2" value="0" required> 0</label>
        <label><input type="radio" name="S2" value="1"> 1</label>
        <label><input type="radio" name="S2" value="2"> 2</label>
        <label><input type="radio" name="S2" value="3"> 3</label>
        <label><input type="radio" name="S2" value="4"> 4</label>
        <label><input type="radio" name="S2" value="5"> 5</label>
        <label>S3: 재활운동을 꾸준히 하면, 회복 또는 개선이 가능하다고 믿는다.</label>
        <label><input type="radio" name="S3" value="0" required> 0</label>
        <label><input type="radio" name="S3" value="1"> 1</label>
        <label><input type="radio" name="S3" value="2"> 2</label>
        <label><input type="radio" name="S3" value="3"> 3</label>
        <label><input type="radio" name="S3" value="4"> 4</label>
        <label><input type="radio" name="S3" value="5"> 5</label>
      </fieldset>
  
      <!-- Acceptance -->
      <fieldset>
        <legend>Acceptance (통증을 어느 정도 수용하고, 활동을 유지하려는 태도)</legend>
        <label>P1: 완벽히 통증이 없어지지 않아도, 할 수 있는 일을 찾아서 해보려고 한다.</label>
        <label><input type="radio" name="P1" value="0" required> 0</label>
        <label><input type="radio" name="P1" value="1"> 1</label>
        <label><input type="radio" name="P1" value="2"> 2</label>
        <label><input type="radio" name="P1" value="3"> 3</label>
        <label><input type="radio" name="P1" value="4"> 4</label>
        <label><input type="radio" name="P1" value="5"> 5</label>
        <label>P2: 통증을 갖고 있더라도, 그 상태에서 가능한 한 일상 활동을 하려고 노력한다.</label>
        <label><input type="radio" name="P2" value="0" required> 0</label>
        <label><input type="radio" name="P2" value="1"> 1</label>
        <label><input type="radio" name="P2" value="2"> 2</label>
        <label><input type="radio" name="P2" value="3"> 3</label>
        <label><input type="radio" name="P2" value="4"> 4</label>
        <label><input type="radio" name="P2" value="5"> 5</label>
        <label>P3: 통증을 ‘내 삶의 일부’로 받아들이면서, 너무 크게 두려워하지 않으려 한다.</label>
        <label><input type="radio" name="P3" value="0" required> 0</label>
        <label><input type="radio" name="P3" value="1"> 1</label>
        <label><input type="radio" name="P3" value="2"> 2</label>
        <label><input type="radio" name="P3" value="3"> 3</label>
        <label><input type="radio" name="P3" value="4"> 4</label>
        <label><input type="radio" name="P3" value="5"> 5</label>
      </fieldset>
  
  <button id="submitBtn">결과 저장</button>
  <div id="resultMessage"></div>
  <button id="backToManagement">관리 페이지로 돌아가기</button>

  <script>
    // URL 파라미터에서 회원 이름 가져오기
    const urlParams = new URLSearchParams(window.location.search);
    const clientNameFromParams = urlParams.get("client");

    document.addEventListener("DOMContentLoaded", () => {
      const clientNameField = document.getElementById("clientName");

      // URL 파라미터로 전달된 회원 이름이 있을 경우 자동 설정
      if (clientNameFromParams) {
        clientNameField.value = clientNameFromParams;
        clientNameField.disabled = true; // 회원 이름 필드 비활성화
      }
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const clientName = document.getElementById("clientName").value || "이름없음";
      const result = calculateICPP();
      const session = await getSession();

      if (!session) {
        alert("로그인이 필요합니다.");
        window.location.href = "index.html";
        return;
      }

      // Supabase 데이터 저장
      const { data, error } = await supabase.from("icpp_assessments").insert([
        {
          user_id: session.user.id,
          client_name: clientName,
          c_score: result.C,
          f_score: result.F,
          k_score: result.K,
          a_score: result.A,
          s_score: result.S,
          p_score: result.P,
          persona_type: result.persona,
          assessment_date: new Date().toISOString(), // 현재 날짜 저장
        },
      ]);

      if (error) {
        console.error("데이터 저장 실패:", error.message);
        document.getElementById("resultMessage").textContent = `저장 실패: ${error.message}`;
      } else {
        alert("설문 결과가 저장되었습니다!");
        window.location.href = "results.html?client=" + encodeURIComponent(clientName);
      }
    });

    // 관리 페이지로 돌아가기 버튼
    document.getElementById("backToManagement").addEventListener("click", () => {
      window.location.href = "dashboard_home.html"; // 관리 페이지로 이동
    });
  </script>
</body>
</html>
